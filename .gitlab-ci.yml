---
stages:
  - test
  - build
  - release

jsonlint:
  stage: test
  image: registry.gitlab.com/pipeline-components/jsonlint:latest
  script:
    - |
      find . -not -path './.git/*' -name '*.json' -type f -print0 |
      parallel --will-cite -k -0 -n1 jsonlint -q

build-initrd:
  stage: build
  image: archlinux:base
  before_script:
    - mkdir -p cache
    - cp -av cache/* /var/cache/pacman/pkg/ || true
    - pacman -Syy --noconfirm base-devel rsync wget go gzip cpio
    - cp -av /var/cache/pacman/pkg/* cache/
  script:
    - make build
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - cache/
  artifacts:
    paths:
      - rootfs.cpio.gz

.go_template_defaults:
  stage: test
.semver_template_defaults:
  stage: release
variables:
  SEMVER_PREFIX: v
include:
  - remote: https://gitlab.com/bonsai-oss/organization/ci-templates/-/raw/main/templates/language/go.yml
  - remote: https://gitlab.com/bonsai-oss/organization/ci-templates/-/raw/main/templates/release/semver.yml

